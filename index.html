const x1 = rect1.left - boardRect.left + rect1.width / 2;
               const y1 = rect1.top - boardRect.top + rect1.height / 2;
               const x2 = rect2.left - boardRect.left + rect2.width / 2;
               const y2 = rect2.top - boardRect.top + rect2.height / 2;
               
               const line = document.createElement('div');
               line.className = 'chain-line';
               
               const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
               const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
               
               line.style.width = length + 'px';
               line.style.left = x1 + 'px';
               line.style.top = y1 + 'px';
               line.style.transform = `rotate(${angle}deg)`;
               line.style.transformOrigin = '0 50%';
               
               document.getElementById('gameBoard').appendChild(line);
           }
       }

       function clearChainLines() {
           document.querySelectorAll('.chain-line').forEach(line => line.remove());
       }

       // ポイント計算
       function calculatePoints() {
           let basePoints = selectedTsums.length * 120;
           let specialBonus = selectedTsums.filter(t => t.dataset.special === 'true').length * 600;
           let comboMultiplier = Math.floor(combo / 3) + 1;
           let chainBonus = selectedTsums.length > 6 ? selectedTsums.length * 80 : 0;
           let levelBonus = level * 50;
           
           return (basePoints + specialBonus + chainBonus + levelBonus) * comboMultiplier;
       }

       // スコア追加
       function addScore(points) {
           score += points;
           updateScore();
           showFloatingScore(points);
       }

       function showFloatingScore(points) {
           const floating = document.createElement('div');
           floating.className = 'floating-score';
           floating.textContent = `+${points}`;
           floating.style.left = Math.random() * 200 + 100 + 'px';
           floating.style.top = '50%';
           
           document.getElementById('gameBoard').appendChild(floating);
           setTimeout(() => floating.remove(), 1000);
       }

       // ツム消去
       function eliminateTsums() {
           selectedTsums.forEach((tsum, index) => {
               setTimeout(() => {
                   if (tsum.parentNode) {
                       tsum.classList.add('eliminating');
                       setTimeout(() => {
                           if (tsum.parentNode) {
                               const newColor = colors[Math.floor(Math.random() * Math.min(5 + level, colors.length))];
                               const isSpecial = Math.random() < 0.06 + (level * 0.015);
                               
                               tsum.className = `tsum ${newColor}${isSpecial ? ' special' : ''} spawning`;
                               tsum.textContent = isSpecial ? '💎' : colorEmojis[newColor];
                               tsum.dataset.color = newColor;
                               tsum.dataset.special = isSpecial;
                               
                               setTimeout(() => tsum.classList.remove('spawning'), 400);
                           }
                       }, 300);
                   }
               }, index * 60);
           });
       }

       // 選択クリア
       function clearSelection() {
           selectedTsums.forEach(tsum => {
               if (tsum.parentNode) {
                   tsum.classList.remove('selected');
               }
           });
           selectedTsums = [];
           chainCount = 0;
       }

       // UI更新
       function updateScore() {
           document.getElementById('score').textContent = score.toLocaleString();
       }

       function updateCombo() {
           if (selectedTsums.length >= 3) {
               combo++;
           }
           document.getElementById('combo').textContent = combo;
       }

       function updateTimer() {
           document.getElementById('timer').textContent = timeLeft;
           
           const timerDisplay = document.getElementById('timerDisplay');
           if (timeLeft <= 10) {
               timerDisplay.classList.add('urgent');
           } else {
               timerDisplay.classList.remove('urgent');
           }
           
           if (timeLeft <= 0) {
               endGame();
           } else {
               timeLeft--;
           }
       }

       function updateChainDisplay() {
           const chainCounter = document.getElementById('chainCounter');
           if (chainCount > 0) {
               chainCounter.style.display = 'block';
               document.getElementById('chainCount').textContent = chainCount;
           }
       }

       function updatePowerUps() {
           document.getElementById('bombCount').textContent = powerUps.bomb;
           document.getElementById('rainbowCount').textContent = powerUps.rainbow;
           document.getElementById('timeCount').textContent = powerUps.time;
           
           document.getElementById('bombPower').classList.toggle('disabled', powerUps.bomb <= 0);
           document.getElementById('rainbowPower').classList.toggle('disabled', powerUps.rainbow <= 0);
           document.getElementById('timePower').classList.toggle('disabled', powerUps.time <= 0);
       }

       // レベルアップ
       function levelUp() {
           level++;
           timeLeft += 12;
           showNotification(`🎉 レベル ${level}！ +12秒ボーナス！`);
           document.getElementById('level').textContent = level;
           
           powerUps.bomb += 1;
           if (level % 2 === 0) powerUps.rainbow += 1;
           if (level % 3 === 0) powerUps.time += 1;
           
           updatePowerUps();
           
           // 強力な振動
           if (navigator.vibrate) {
               navigator.vibrate([200, 100, 200, 100, 200]);
           }
       }

       // パワーアップ使用
       function usePowerUp(type) {
           if (!gameRunning || powerUps[type] <= 0) return;
           
           powerUps[type]--;
           updatePowerUps();
           
           if (navigator.vibrate) {
               navigator.vibrate(120);
           }
           
           switch(type) {
               case 'bomb':
                   const randomTsums = [...tsums].sort(() => Math.random() - 0.5).slice(0, 15);
                   randomTsums.forEach((tsum, index) => {
                       setTimeout(() => {
                           if (tsum.parentNode) {
                               tsum.classList.add('eliminating');
                               setTimeout(() => {
                                   if (tsum.parentNode) {
                                       const newColor = colors[Math.floor(Math.random() * colors.length)];
                                       const isSpecial = Math.random() < 0.1;
                                       
                                       tsum.className = `tsum ${newColor}${isSpecial ? ' special' : ''} spawning`;
                                       tsum.textContent = isSpecial ? '💎' : colorEmojis[newColor];
                                       tsum.dataset.color = newColor;
                                       tsum.dataset.special = isSpecial;
                                       
                                       setTimeout(() => tsum.classList.remove('spawning'), 400);
                                   }
                               }, 300);
                           }
                       }, index * 40);
                   });
                   addScore(1500);
                   showNotification('💣 ボム爆発！');
                   break;
                   
               case 'rainbow':
                   const dominantColor = colors[Math.floor(Math.random() * colors.length)];
                   tsums.forEach((tsum, index) => {
                       if (Math.random() < 0.4) {
                           setTimeout(() => {
                               tsum.dataset.color = dominantColor;
                               tsum.className = `tsum ${dominantColor}`;
                               tsum.textContent = colorEmojis[dominantColor];
                               tsum.style.transform = 'scale(1.2)';
                               setTimeout(() => {
                                   tsum.style.transform = '';
                               }, 200);
                           }, index * 20);
                       }
                   });
                   showNotification('🌈 レインボー発動！');
                   break;
                   
               case 'time':
                   timeLeft += 25;
                   showNotification('⏰ +25秒追加！');
                   break;
           }
       }

       // 実績チェック
       function checkAchievements() {
           const newAchievements = [];
           
           if (!achievements.has('firstPlay') && score > 0) {
               newAchievements.push('firstPlay');
           }
           if (!achievements.has('score1000') && score >= 1000) {
               newAchievements.push('score1000');
           }
           if (!achievements.has('score5000') && score >= 5000) {
               newAchievements.push('score5000');
           }
           if (!achievements.has('combo10') && combo >= 10) {
               newAchievements.push('combo10');
           }
           if (!achievements.has('speedDemon') && (Date.now() - gameStartTime) < 25000 && score >= 3000) {
               newAchievements.push('speedDemon');
           }
           if (!achievements.has('perfectGame') && perfectGame && score >= 4000) {
               newAchievements.push('perfectGame');
           }
           
           newAchievements.forEach(achievementId => {
               achievements.add(achievementId);
               const achievement = achievementList.find(a => a.id === achievementId);
               if (achievement) {
                   showAchievement(achievement);
                   showNotification(`🏆 ${achievement.icon} ${achievement.name} 達成！`);
               }
           });
           
           saveAchievements();
       }

       function showAchievement(achievement) {
           const elem = document.createElement('div');
           elem.className = 'achievement';
           elem.textContent = `${achievement.icon} ${achievement.name}`;
           
           document.getElementById('achievementDisplay').appendChild(elem);
           
           setTimeout(() => elem.classList.add('show'), 100);
           setTimeout(() => {
               elem.style.opacity = '0';
               setTimeout(() => elem.remove(), 300);
           }, 3000);
       }

       // 通知表示
       function showNotification(message) {
           const notification = document.createElement('div');
           notification.className = 'notification';
           notification.textContent = message;
           document.body.appendChild(notification);
           setTimeout(() => notification.remove(), 2000);
       }

       // ゲーム開始
       function startGame() {
           gameRunning = true;
           gameStartTime = Date.now();
           score = 0;
           timeLeft = 60;
           combo = 0;
           level = 1;
           perfectGame = true;
           
           updateScore();
           updateTimer();
           updateCombo();
           updatePowerUps();
           
           document.getElementById('level').textContent = level;
           document.getElementById('startBtn').textContent = '実行中';
           document.getElementById('startBtn').style.opacity = '0.5';
           
           initializeBoard();
           
           gameTimer = setInterval(updateTimer, 1000);
           
           // ランダムイベント開始
           setTimeout(randomEvent, Math.random() * 15000 + 8000);
           
           showNotification('🚀 ゲーム開始！連鎖を狙え！');
           
           if (navigator.vibrate) {
               navigator.vibrate([100, 50, 100]);
           }
       }

       // ランダムイベント
       function randomEvent() {
           if (!gameRunning) return;
           
           const events = [
               () => {
                   timeLeft += 8;
                   showNotification('🎁 時間ボーナス！+8秒');
               },
               () => {
                   powerUps.bomb += 2;
                   updatePowerUps();
                   showNotification('💣 ボム×2 プレゼント！');
               },
               () => {
                   const specialCount = Math.floor(Math.random() * 8) + 5;
                   const randomTsums = [...tsums].sort(() => Math.random() - 0.5).slice(0, specialCount);
                   randomTsums.forEach(tsum => {
                       tsum.dataset.special = 'true';
                       tsum.classList.add('special');
                       tsum.textContent = '💎';
                   });
                   showNotification('✨ 特殊ツム大発生！');
               },
               () => {
                   const bonusScore = Math.floor(Math.random() * 1200) + 600;
                   addScore(bonusScore);
                   showNotification(`🌟 ラッキー！+${bonusScore}点！`);
               }
           ];
           
           const randomEventFunc = events[Math.floor(Math.random() * events.length)];
           randomEventFunc();
           
           // 次のイベント予約
           setTimeout(randomEvent, Math.random() * 20000 + 12000);
       }

       // ゲーム終了
       function endGame() {
           gameRunning = false;
           clearInterval(gameTimer);
           clearSelection();
           clearChainLines();
           
           document.getElementById('startBtn').textContent = '開始';
           document.getElementById('startBtn').style.opacity = '1';
           
           checkAchievements();
           
           let message = `🎮 ゲーム終了！\n\n`;
           message += `📊 最終スコア: ${score.toLocaleString()}点\n`;
           message += `🎯 到達レベル: ${level}\n`;
           message += `🔥 最高コンボ: ${combo}連鎖\n`;
           message += `⭐ 獲得実績: ${achievements.size}個\n\n`;
           
           if (score >= 5000) {
               message += `🏆 素晴らしいスコアです！\n`;
           } else if (score >= 2000) {
               message += `👍 良いスコアです！\n`;
           } else {
               message += `💪 次回はもっと頑張りましょう！\n`;
           }
           
           message += `\n🔄 もう一度挑戦しますか？`;
           
           setTimeout(() => {
               if (confirm(message)) {
                   startGame();
               }
           }, 1000);
       }

       // ゲームリセット
       function resetGame() {
           gameRunning = false;
           clearInterval(gameTimer);
           score = 0;
           timeLeft = 60;
           combo = 0;
           level = 1;
           chainCount = 0;
           
           updateScore();
           updateTimer();
           updateCombo();
           clearSelection();
           clearChainLines();
           
           document.getElementById('level').textContent = level;
           document.getElementById('chainCounter').style.display = 'none';
           document.getElementById('startBtn').textContent = '開始';
           document.getElementById('startBtn').style.opacity = '1';
           
           initializeBoard();
       }

       // 実績管理
       function loadAchievements() {
           const saved = localStorage.getItem('tsumAchievements');
           if (saved) {
               achievements = new Set(JSON.parse(saved));
           }
       }

       function saveAchievements() {
           localStorage.setItem('tsumAchievements', JSON.stringify([...achievements]));
       }

       // PWA関連
       if ('serviceWorker' in navigator) {
           navigator.serviceWorker.register('/service-worker.js')
               .then(registration => console.log('PWA ready'))
               .catch(error => console.log('PWA failed'));
       }

       // インストールプロンプト
       let deferredPrompt;
       window.addEventListener('beforeinstallprompt', (e) => {
           e.preventDefault();
           deferredPrompt = e;
       });

       // フルスクリーン対応
       function toggleFullscreen() {
           if (!document.fullscreenElement) {
               document.documentElement.requestFullscreen().catch(err => {
                   console.log(`Fullscreen error: ${err.message}`);
               });
           } else {
               document.exitFullscreen();
           }
       }

       // 画面回転対応
       window.addEventListener('orientationchange', () => {
           setTimeout(() => {
               if (gameRunning) {
                   clearChainLines();
               }
           }, 500);
       });

       // バックグラウンド処理停止
       document.addEventListener('visibilitychange', () => {
           if (document.hidden && gameRunning) {
               // ゲームを一時停止
               clearInterval(gameTimer);
           } else if (!document.hidden && gameRunning) {
               // ゲームを再開
               gameTimer = setInterval(updateTimer, 1000);
           }
       });

       // デバッグ用（開発時のみ）
       if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
           window.debugGame = {
               addScore: (points) => addScore(points),
               levelUp: () => levelUp(),
               addPowerUp: (type, count) => {
                   powerUps[type] += count;
                   updatePowerUps();
               }
           };
       }

       // 長押し防止
       document.addEventListener('contextmenu', e => e.preventDefault());
       
       // 拡大防止
       document.addEventListener('gesturestart', e => e.preventDefault());
       document.addEventListener('gesturechange', e => e.preventDefault());
       document.addEventListener('gestureend', e => e.preventDefault());
       
       // スワイプ無効化
       let startY;
       document.addEventListener('touchstart', e => {
           startY = e.touches[0].clientY;
       });
       
       document.addEventListener('touchmove', e => {
           const y = e.touches[0].clientY;
           if (!e.target.closest('.game-board') && Math.abs(y - startY) > 10) {
               e.preventDefault();
           }
       }, { passive: false });
   </script>
</body>
</html>
